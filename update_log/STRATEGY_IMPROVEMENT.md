# 策略改进指南 - 提升胜率和盈亏比

## 🎯 改进目标

1. **提升胜率**：通过多重确认机制过滤低质量信号
2. **确保盈亏比**：每次开单至少盈亏比 >= 1.5

## ✨ 新增功能

### 1. 信号质量评分系统

系统会对每个信号进行多维度评分，包括：

#### 评分维度（总分可达 150+ 分）

1. **趋势确认** (+20分)
   - EMA 多头排列（EMA21 > EMA55 > EMA100）

2. **价格位置确认** (+15分)
   - 价格在 EMA 上方

3. **成交量确认** (+15-20分)
   - 成交量放大 1.2x：+15分
   - 成交量放大 1.5x：+20分

4. **RSI 确认** (+5-10分)
   - RSI 健康区间（40-70）：+10分
   - RSI 超卖（<30）：+5分

5. **MACD 确认** (+15分)
   - MACD 多头（MACD > Signal）

6. **布林带确认** (+10分)
   - 价格在布林带中轨上方

7. **ATR 波动率确认** (+10分 或 -10分)
   - 波动率正常（<1.5x）：+10分
   - 波动率过高（>2.0x）：-10分

8. **Eric Score 确认** (+10-15分)
   - Eric Score 中性（-0.5 到 0.5）：+15分
   - Eric Score 超卖（<-0.7）：+10分

9. **价格动量确认** (+10分)
   - 5周期正动量

10. **支撑位确认** (+15分)
    - 接近支撑位但未跌破（0-2%）

11. **LLM 评分加权** (+10-20分)
    - LLM 评分 >= 70：+20分
    - LLM 评分 >= 60：+10分

#### 过滤条件

- **最小质量评分**：默认 50 分
- **最小确认数量**：默认 2 个确认
- **最小 LLM 评分**：默认 40 分

### 2. 动态盈亏比计算

系统会自动计算并调整止损止盈，确保盈亏比 >= 1.5：

```python
# 初始止损止盈
止损 = 入场价 - ATR * 1.0
止盈 = 入场价 + ATR * 2.0

# 计算盈亏比
风险 = |入场价 - 止损|
收益 = |止盈 - 入场价|
盈亏比 = 收益 / 风险

# 如果盈亏比 < 1.5，自动调整止盈
if 盈亏比 < 1.5:
    所需收益 = 风险 * 1.5
    止盈 = 入场价 + 所需收益
```

**特点**：
- ✅ 自动确保盈亏比 >= 1.5
- ✅ 如果初始止盈不满足，自动调整
- ✅ 不满足盈亏比的信号会被过滤

## 📊 配置参数

### 环境变量配置

```bash
# 启用信号过滤器（默认 True）
USE_SIGNAL_FILTER=True

# 最小盈亏比要求（默认 1.5）
MIN_RISK_REWARD=1.5

# 最小质量评分（默认 50）
MIN_QUALITY_SCORE=50

# 最小确认数量（默认 2）
MIN_CONFIRMATIONS=2

# 最小 LLM 评分（默认 40）
MIN_LLM_SCORE=40
```

### .env 文件配置

```env
USE_SIGNAL_FILTER=True
MIN_RISK_REWARD=1.5
MIN_QUALITY_SCORE=50
MIN_CONFIRMATIONS=2
MIN_LLM_SCORE=40
```

## 🚀 使用方法

### 基础使用

```bash
# 使用默认配置（盈亏比 >= 1.5，质量评分 >= 50）
python3 main.py
```

### 自定义配置

```bash
# 更严格的过滤（盈亏比 >= 2.0，质量评分 >= 70）
MIN_RISK_REWARD=2.0 MIN_QUALITY_SCORE=70 python3 main.py

# 更宽松的过滤（盈亏比 >= 1.2，质量评分 >= 40）
MIN_RISK_REWARD=1.2 MIN_QUALITY_SCORE=40 python3 main.py
```

### 禁用信号过滤器

```bash
# 如果不想使用信号过滤器
USE_SIGNAL_FILTER=False python3 main.py
```

## 📈 效果对比

### 过滤前
- 信号数量：41 个
- 胜率：16.67%
- 平均盈亏比：可能 < 1.5

### 过滤后
- 信号数量：7 个（高质量信号）
- 胜率：预期提升
- 平均盈亏比：>= 1.5（所有信号）

## 🔍 信号过滤流程

```
1. 检测原始信号
   └─> 41 个信号

2. AI 增强
   └─> 41 个增强信号

3. 信号质量评分 ⭐
   └─> 对每个信号进行多维度评分
   └─> 过滤：质量评分 < 50 的信号

4. 盈亏比计算 ⭐
   └─> 计算每个信号的预期盈亏比
   └─> 自动调整止盈以满足最小盈亏比要求
   └─> 过滤：盈亏比 < 1.5 的信号

5. 最终信号
   └─> 7 个高质量信号（质量评分 >= 50，盈亏比 >= 1.5）

6. 回测执行
   └─> 只执行高质量信号
```

## 💡 优化建议

### 1. 根据市场调整参数

**趋势市场**：
- `MIN_QUALITY_SCORE=40`（降低要求，捕捉更多机会）
- `MIN_RISK_REWARD=1.5`（标准盈亏比）

**震荡市场**：
- `MIN_QUALITY_SCORE=60`（提高要求，减少假信号）
- `MIN_RISK_REWARD=2.0`（提高盈亏比要求）

**高波动市场**：
- `MIN_QUALITY_SCORE=70`（非常严格）
- `MIN_RISK_REWARD=2.5`（高盈亏比）

### 2. 调整确认数量

- **保守策略**：`MIN_CONFIRMATIONS=3`（需要更多确认）
- **积极策略**：`MIN_CONFIRMATIONS=2`（标准）
- **激进策略**：`MIN_CONFIRMATIONS=1`（较少确认）

### 3. 结合 Eric 指标

启用 Eric 指标可以增加更多确认维度：
```bash
USE_ERIC_INDICATORS=True USE_SIGNAL_FILTER=True
```

## 📊 信号质量评分示例

### 高质量信号（评分 85）

```
✅ EMA多头排列 (+20)
✅ 价格在EMA上方 (+15)
✅ 成交量放大1.5x (+20)
✅ RSI健康 (+10)
✅ MACD多头 (+15)
✅ 接近支撑位 (+15)
─────────────────
总分: 85
```

### 低质量信号（评分 25）

```
✅ EMA多头排列 (+20)
❌ 成交量不足
❌ RSI过热
❌ 波动率过高 (-10)
─────────────────
总分: 25 (被过滤)
```

## 🎯 关键改进点

1. **多重确认机制**：不是单一指标，而是多维度综合评分
2. **自动盈亏比调整**：确保每次开单盈亏比 >= 1.5
3. **波动率过滤**：避免在高波动时交易
4. **支撑位确认**：增加价格位置确认
5. **动量确认**：确保有正向动量

## 📝 注意事项

1. **信号数量减少**：过滤后信号数量会显著减少，这是正常的
2. **质量提升**：虽然数量减少，但质量提升，胜率应该提高
3. **参数调优**：根据实际回测结果调整参数
4. **市场适应**：不同市场可能需要不同的参数设置

## 🔧 故障排除

### 问题：没有信号通过过滤

**解决方案**：
1. 降低 `MIN_QUALITY_SCORE`（如从 50 降到 40）
2. 降低 `MIN_CONFIRMATIONS`（如从 2 降到 1）
3. 检查数据质量（是否有足够的技术指标）

### 问题：信号太少

**解决方案**：
1. 调整评分权重（在 `signal_filter.py` 中）
2. 降低质量评分要求
3. 增加数据量

### 问题：盈亏比不满足

**解决方案**：
1. 系统会自动调整止盈，如果仍不满足，信号会被过滤
2. 可以降低 `MIN_RISK_REWARD`（如从 1.5 降到 1.2）
3. 检查 ATR 计算是否正确

## 📚 相关文件

- `strategy/signal_filter.py` - 信号过滤核心逻辑
- `backtest/simulator.py` - 回测系统（已集成盈亏比检查）
- `config.py` - 配置参数
- `main.py` - 主程序（已集成信号过滤）

