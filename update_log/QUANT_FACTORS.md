# 量化因子与规则体系

## 一、10个可回测、无未来函数的量化因子

1. **价格动量因子**：过去20根K线的收益率，公式：`(close[t] - close[t-20]) / close[t-20]`
2. **ATR波动率因子**：14周期ATR相对于价格的百分比，公式：`(ATR14[t] / close[t]) * 100`
3. **EMA斜率因子**：EMA21的斜率，公式：`(EMA21[t] - EMA21[t-5]) / EMA21[t-5]`
4. **价格位置因子**：当前价格在过去50根K线价格区间中的位置，公式：`(close[t] - low_50) / (high_50 - low_50)`
5. **成交量比率因子**：当前成交量与50周期平均成交量的比值，公式：`volume[t] / vol_ma50[t]`
6. **RSI因子**：14周期RSI值，公式：`RSI14[t]`
7. **EMA距离因子**：价格与EMA21的距离百分比，公式：`(close[t] - EMA21[t]) / EMA21[t] * 100`
8. **趋势一致性因子**：过去50根K线中上涨K线占比，公式：`sum(close[t-i] > close[t-i-1] for i in range(50)) / 50`
9. **价格效率因子**：价格变化与价格波动范围的比值，公式：`abs(close[t] - close[t-50]) / (high_50 - low_50)`
10. **最大回撤因子**：过去50根K线的最大回撤百分比，公式：`max((cumulative[t-i] - peak[t-i]) / peak[t-i] for i in range(50))`

## 二、因子剔除（减少过拟合）

**保留的因子**（无未来函数、可实盘计算）：
1. 价格动量因子
2. ATR波动率因子
3. EMA斜率因子
4. 价格位置因子
5. 成交量比率因子
6. RSI因子
7. EMA距离因子
8. 趋势一致性因子
9. 价格效率因子
10. 最大回撤因子

**剔除的因子**（可能导致过拟合）：
- 使用未来数据的因子（如：`close[t+1]`）
- 需要优化参数的因子（如：动态调整的窗口期）
- 计算过于复杂的因子（如：多层嵌套的统计量）

## 三、多因子组合（打分模型）

### 组合1：趋势动量组合
```
Score = 0.3 * 价格动量因子 + 0.2 * EMA斜率因子 + 0.2 * 趋势一致性因子 + 0.15 * 成交量比率因子 + 0.15 * 价格效率因子
```

### 组合2：波动率调整组合
```
Score = 0.25 * 价格动量因子 + 0.25 * ATR波动率因子 + 0.2 * 价格位置因子 + 0.15 * RSI因子 + 0.15 * EMA距离因子
```

### 组合3：综合平衡组合
```
Score = 0.2 * 价格动量因子 + 0.15 * ATR波动率因子 + 0.15 * EMA斜率因子 + 0.15 * 价格位置因子 + 0.1 * 成交量比率因子 + 0.1 * RSI因子 + 0.1 * EMA距离因子 + 0.05 * 趋势一致性因子
```

## 四、因子重要性排序（逻辑层面）

1. **价格动量因子**：直接反映价格变化趋势，预测意义最强
2. **EMA斜率因子**：反映趋势加速度，具有中期预测意义
3. **ATR波动率因子**：反映市场风险水平，影响信号可靠性
4. **价格位置因子**：反映价格在区间中的位置，判断超买超卖
5. **成交量比率因子**：反映市场参与度，验证价格变化的有效性
6. **趋势一致性因子**：反映趋势的持续性，判断趋势强度
7. **RSI因子**：反映超买超卖状态，具有反转预测意义
8. **EMA距离因子**：反映价格与均线的偏离程度
9. **价格效率因子**：反映趋势的"干净"程度
10. **最大回撤因子**：反映风险水平，主要用于风险管理

## 五、高频特征提取（1分钟数据）

1. **短期动量**：过去5根1分钟K线的收益率
2. **ATR比率**：当前ATR与过去20根K线ATR均值的比值
3. **成交量爆发**：当前成交量与过去20根K线成交量均值的比值
4. **价格波动率**：过去10根K线的标准差
5. **EMA21距离**：价格与EMA21的距离百分比
6. **RSI14**：14周期RSI值
7. **价格效率**：价格变化与价格波动范围的比值（5根K线）
8. **上下影比**：上影线长度与下影线长度的比值
9. **实体占比**：K线实体长度与总波动范围的比值
10. **连续方向**：连续上涨或下跌的K线数量

## 六、波动率Regime因子（5个）

1. **ATR相对位置**：`(ATR14[t] - ATR14_MA20[t]) / ATR14_MA20[t]`，判断当前ATR相对于历史均值的偏离
2. **波动率聚集度**：`std(returns[t-20:t]) / mean(abs(returns[t-20:t]))`，判断波动率的聚集程度
3. **价格波动范围**：`(high_20[t] - low_20[t]) / close[t]`，20根K线的价格波动范围
4. **ATR趋势**：`(ATR14[t] - ATR14[t-10]) / ATR14[t-10]`，ATR的变化趋势
5. **波动率效率**：`abs(close[t] - close[t-20]) / sum(abs(returns[t-20:t]))`，价格变化与总波动的比值

## 七、趋势过滤规则（5条）

1. **EMA多头排列过滤**：`close[t] > EMA21[t] > EMA55[t] > EMA100[t]`
2. **趋势强度过滤**：`trend_strength[t] > 50`（基于斜率、一致性、突破、均线排列、ATR的综合评分）
3. **波动率过滤**：`1% <= (ATR14[t] / close[t]) * 100 <= 5%`（避免极端波动）
4. **斜率过滤**：`(EMA21[t] - EMA21[t-10]) / EMA21[t-10] > 0.5%`（EMA21向上倾斜）
5. **一致性过滤**：`sum(close[t-i] > close[t-i-1] for i in range(20)) / 20 > 0.6`（过去20根K线中60%以上上涨）

## 八、震荡区假突破过滤规则（5条）

1. **成交量验证**：`volume[t] / vol_ma50[t] < 1.2`（突破时成交量未放大，可能是假突破）
2. **回踩验证**：突破后3根K线内，价格回落到突破位下方，判定为假突破
3. **波动率验证**：`ATR14[t] / ATR14_MA20[t] < 0.8`（突破时波动率低于历史均值，可能是假突破）
4. **实体验证**：突破K线的实体占比 < 0.5（实体太小，可能是假突破）
5. **持续性验证**：突破后连续3根K线收盘价都在突破位上方，否则判定为假突破

## 九、低波动行情过滤规则（5条）

1. **ATR百分比过滤**：`(ATR14[t] / close[t]) * 100 < 0.5%`（ATR低于0.5%）
2. **价格波动范围过滤**：`(high_20[t] - low_20[t]) / close[t] < 1%`（20根K线波动范围小于1%）
3. **ATR趋势过滤**：`ATR14[t] < ATR14_MA20[t] * 0.7`（当前ATR低于历史均值70%）
4. **成交量萎缩过滤**：`volume[t] / vol_ma50[t] < 0.8`（成交量低于均值）
5. **价格效率过滤**：`abs(close[t] - close[t-20]) / (high_20[t] - low_20[t]) < 0.3`（价格效率低于30%）

## 十、假信号过滤规则（10条）

1. **EMA排列过滤**：`EMA21[t] > EMA55[t] > EMA100[t]`（多头排列）
2. **趋势强度过滤**：`trend_strength[t] > 50`
3. **ATR过滤**：`(ATR14[t] / close[t]) * 100 >= 0.5%`
4. **成交量验证**：`volume[t] / vol_ma50[t] >= 1.2`
5. **RSI过滤**：`30 < RSI14[t] < 70`（避免超买超卖区域）
6. **价格位置过滤**：`0.2 < (close[t] - low_50[t]) / (high_50[t] - low_50[t]) < 0.8`（价格不在极端位置）
7. **突破有效性过滤**：突破后连续3根K线收盘价都在突破位上方
8. **波动率稳定性过滤**：`0.7 < ATR14[t] / ATR14_MA20[t] < 1.5`（波动率相对稳定）
9. **价格效率过滤**：`abs(close[t] - close[t-20]) / (high_20[t] - low_20[t]) > 0.3`
10. **趋势一致性过滤**：`sum(close[t-i] > close[t-i-1] for i in range(10)) / 10 > 0.6`

## 十一、入场规则（基于结构信号，3套）

### 入场规则1：突破确认入场
```
条件1: close[t] > res50[t]（突破50周期高点）
条件2: volume[t] / vol_ma50[t] >= 1.2（成交量放大）
条件3: close[t-1] <= res50[t]（前一根K线未突破）
条件4: close[t-2:t+1] 连续3根收盘价都在res50上方（持续性验证）
```

### 入场规则2：EMA多头排列入场
```
条件1: close[t] > EMA21[t] > EMA55[t] > EMA100[t]（EMA多头排列）
条件2: (close[t] - EMA21[t]) / EMA21[t] < 2%（价格未过度偏离EMA21）
条件3: (EMA21[t] - EMA21[t-5]) / EMA21[t-5] > 0.3%（EMA21向上倾斜）
条件4: volume[t] / vol_ma50[t] >= 1.1（成交量略放大）
```

### 入场规则3：趋势反转入场
```
条件1: close[t] > close[t-1] > close[t-2]（连续3根上涨）
条件2: close[t] > EMA21[t]（价格站上EMA21）
条件3: RSI14[t] < 50 且 RSI14[t] > RSI14[t-3]（RSI从超卖区域反弹）
条件4: volume[t] / vol_ma50[t] >= 1.15（成交量放大）
```

## 十二、出场规则（5条）

1. **结构破坏出场**：`close[t] < EMA21[t]` 且 `EMA21[t] < EMA21[t-1]`（价格跌破EMA21且EMA21开始下降）
2. **均线反转出场**：`EMA21[t] < EMA55[t]`（EMA21下穿EMA55，多头排列破坏）
3. **波动率扩张出场**：`ATR14[t] / ATR14_MA20[t] > 2.0`（波动率异常扩张，风险增加）
4. **反向信号出场**：出现反向结构信号（如：做多时出现做空信号）
5. **止损出场**：`close[t] < entry_price - ATR14[entry_idx] * 1.0`（价格跌破止损位）

## 十三、止盈止损体系（5套）

### 体系1：ATR动态止损止盈
```
止损: entry_price - ATR14[entry_idx] * 1.0
止盈1（部分）: entry_price + ATR14[entry_idx] * 1.5（50%仓位）
止盈2（全部）: entry_price + ATR14[entry_idx] * 2.5（剩余50%仓位）
```

### 体系2：结构止损止盈
```
止损: 最近20根K线最低点下方0.1%
止盈1（部分）: 最近20根K线最高点（50%仓位）
止盈2（全部）: entry_price + (entry_price - stop_loss) * 2.0（剩余50%仓位）
```

### 体系3：波动率调整止损止盈
```
止损: entry_price - ATR14[entry_idx] * (0.8 + 0.4 * volatility_regime_factor)
止盈1（部分）: entry_price + ATR14[entry_idx] * (1.5 + 0.5 * volatility_regime_factor)
止盈2（全部）: entry_price + ATR14[entry_idx] * (2.5 + 0.5 * volatility_regime_factor)
其中 volatility_regime_factor = (ATR14[t] / ATR14_MA20[t] - 1)
```

### 体系4：趋势跟踪止损止盈
```
止损: max(entry_price - ATR14[entry_idx] * 1.0, EMA21[t] - ATR14[t] * 0.5)（动态止损，跟随EMA21）
止盈1（部分）: entry_price + ATR14[entry_idx] * 1.5
止盈2（全部）: 当价格 > 止盈1 时，止损上移至 entry_price + ATR14[entry_idx] * 1.0（移动止损）
```

### 体系5：多级止盈止损
```
止损: entry_price - ATR14[entry_idx] * 1.0
止盈1（30%仓位）: entry_price + ATR14[entry_idx] * 1.2
止盈2（30%仓位）: entry_price + ATR14[entry_idx] * 2.0
止盈3（40%仓位）: entry_price + ATR14[entry_idx] * 3.0
```

## 十四、多因子交易规则（5套）

### 规则1：趋势动量规则
```
入场条件:
  - 价格动量因子 > 0.02（2%上涨）
  - EMA斜率因子 > 0.003（0.3%向上）
  - 趋势一致性因子 > 0.6
  - 成交量比率因子 >= 1.2
  - 趋势强度 > 50

出场条件:
  - 价格动量因子 < -0.01（1%下跌）
  - 或 EMA斜率因子 < 0（EMA开始下降）
```

### 规则2：波动率调整规则
```
入场条件:
  - 价格动量因子 > 0.015
  - ATR波动率因子在 1% - 3% 之间
  - 价格位置因子 > 0.5（价格在区间上半部分）
  - 成交量比率因子 >= 1.15
  - RSI因子在 40 - 70 之间

出场条件:
  - ATR波动率因子 > 5%（波动率异常扩张）
  - 或 价格位置因子 < 0.3（价格回落）
```

### 规则3：反转捕捉规则
```
入场条件:
  - RSI因子 < 40 且 RSI因子 > RSI[t-3]（RSI从超卖反弹）
  - 价格动量因子 > 0.01
  - EMA距离因子 < -1%（价格低于EMA21）
  - 成交量比率因子 >= 1.2
  - 最大回撤因子 > 0.03（近期有较大回撤）

出场条件:
  - RSI因子 > 70（超买）
  - 或 价格动量因子 < -0.01
```

### 规则4：突破确认规则
```
入场条件:
  - 价格位置因子 > 0.95（接近区间高点）
  - 价格动量因子 > 0.02
  - 成交量比率因子 >= 1.3（显著放量）
  - 价格效率因子 > 0.5
  - 趋势一致性因子 > 0.65

出场条件:
  - 价格位置因子 < 0.9（价格回落）
  - 或 成交量比率因子 < 0.8（成交量萎缩）
```

### 规则5：综合平衡规则
```
入场条件:
  - 多因子组合得分 > 60（综合评分）
  - EMA多头排列
  - 趋势强度 > 50
  - ATR波动率因子在 0.5% - 5% 之间
  - 成交量比率因子 >= 1.1

出场条件:
  - 多因子组合得分 < 40
  - 或 结构破坏（EMA排列破坏）
  - 或 波动率异常扩张
```

## 十五、策略参数调整建议

基于因子特性、波动率分布、结构特征：

1. **ATR倍数调整**：根据当前ATR波动率因子动态调整，高波动时增大倍数，低波动时减小倍数
2. **成交量阈值调整**：根据市场活跃度调整，活跃市场提高阈值，低迷市场降低阈值
3. **趋势强度阈值调整**：根据市场结构调整，趋势市场提高阈值，震荡市场降低阈值
4. **RSI区间调整**：根据波动率调整，高波动时扩大区间，低波动时缩小区间
5. **EMA周期调整**：根据时间框架调整，短周期用短EMA，长周期用长EMA

## 十六、过拟合风险检查

**可能存在过拟合风险的部分**：

1. **过多参数优化**：如动态调整的窗口期、阈值等
2. **复杂因子组合**：过多因子组合可能导致样本内过拟合
3. **固定阈值**：硬编码的阈值可能只适用于特定市场环境
4. **多重过滤条件**：过多过滤条件可能导致样本外表现差
5. **数据挖掘偏差**：基于历史数据优化的参数可能无法泛化

## 十七、防过拟合策略重写

### 重写原则：
1. **减少参数数量**：使用固定、合理的参数，避免过度优化
2. **改为结构逻辑**：基于市场结构而非统计优化
3. **避免过多阈值**：使用相对阈值而非绝对阈值

### 重写后的策略：

**入场规则（简化版）**：
```
条件1: EMA多头排列（EMA21 > EMA55 > EMA100）
条件2: 价格动量 > 0（价格上涨）
条件3: 成交量放大（volume > vol_ma50 * 1.2）
条件4: 趋势强度 > 50
```

**出场规则（简化版）**：
```
条件1: EMA排列破坏（EMA21 < EMA55）
条件2: 价格动量 < 0（价格下跌）
条件3: 止损触发（价格 < entry_price - ATR * 1.0）
```

**止盈止损（简化版）**：
```
止损: entry_price - ATR14 * 1.0
止盈: entry_price + ATR14 * 2.0（确保盈亏比 >= 2.0）
```

